<div class="content">
  <div class="container">
      <% @vendors.each do |vendor| -%>
        <h3>Laika Inspection ID: <%= vendor.public_id %></h3>
        <table id="dashboard">
          <tr>
            <th><a href="#"><div>Status</div></a></th>
            <th class="selected"><a href="#"><div>Test Case</div></a></th>
            <th><a href="#"><div>Last Tested</div></a></th>
            <th><a href="#"><div>Test Type</div></a></th>
            <th><a href="#"><div>Errors</div></a></th>
            <th><a href="#"><div>Warnings</div></a></th>
            <th class="noarrow"><div>Actions</div></th>
          </tr>
        <% @vendor_test_plans[vendor].each do |vendor_test_plan| -%>
          <tr id="vendor_test_plan_<%= vendor_test_plan.id %>"><td>
            <% if vendor_test_plan.clinical_document %>
              <% if vendor_test_plan.validated? %>
                <% if @errors[vendor_test_plan] > 0 %>
                  <%= image_tag "fail.png", :alt => 'Test Failed' %>failed</td>
                <% else %>
                  <%= image_tag "pass.png", :alt => 'Test Passed' %>passed</td>
                <% end %> 
              <% else %>
                <%= image_tag "fail.png", :alt => 'Test Failed' %>failed</td>
              <% end %>
            <% else %>
              <%= image_tag "inprogress.png", :alt => 'Test In Progress' %>in progress</td>
            <% end %>
            <td>
            <% if vendor_test_plan.clinical_document && !vendor_test_plan.validated? %>
              <%= vendor_test_plan.patient_data.name %>
            <% else %>
              <%= link_to h(vendor_test_plan.patient_data.name), patient_data_instance_url(vendor_test_plan.patient_data) %>
            <% end %>
          </td>
          <td><%= vendor_test_plan.updated_at.strftime("%d.%b.%Y %I:%M %p %Z")  %></td>
          <td><%= vendor_test_plan.kind.name %></td>
          <td>
            <% if vendor_test_plan.clinical_document %>
              <%  if !vendor_test_plan.validated?
                    error_count_link_text = "validation error"
                  else
                    error_count_link_text = pluralize(@errors[vendor_test_plan], "Error")
                  end %>
              <%= link_to error_count_link_text, validate_vendor_test_plan_url(vendor_test_plan) %>
            <% else %>
              --
            <% end %>
          </td>
          <td>
            <% if vendor_test_plan.clinical_document %>
              <%  if !vendor_test_plan.validated?
                    warning_count_link_text = "N/A"
                  else
                    warning_count_link_text = pluralize(@warnings[vendor_test_plan], "Warning")
                  end %>
              <%= link_to warning_count_link_text, validate_vendor_test_plan_url(vendor_test_plan) %>
            <% else %>
              --
            <% end %>
          </td>
          <td class="actions">
            <% if vendor_test_plan.clinical_document %>
               <%  if !vendor_test_plan.validated? %>
                <%= link_to 'revalidate', revalidate_vendor_test_plan_url(vendor_test_plan) %>
              <% end %>
              <%= link_to 'delete', vendor_test_plan, :confirm => 'Are you sure you want to delete this Laika test?', :method => :delete %>
              <% if vendor_test_plan.validated? %>
                <%= link_to 'inspect', validate_vendor_test_plan_url(vendor_test_plan) %>
                <%= link_to 'checklist', {:controller => 'vendor_test_plans', :action => 'checklist', :id => vendor_test_plan.id} %>
              <% end %>
            <% else %>
              <%= link_to 'edit', patient_data_instance_url(vendor_test_plan.patient_data)%>
              <%= link_to 'delete', vendor_test_plan, :confirm => 'Are you sure you want to delete this Laika test?', :method => :delete %>
              <% if vendor_test_plan.kind.name == "Generate and Format" %>
                <a href="javascript:toggle_div('execution_div_<%=vendor_test_plan.id%>');">execute</a>
              <% else %>
                <%= link_to 'xml', patient_data_instance_url(vendor_test_plan.patient_data, :format => 'xml') %> 
                <%= link_to 'checklist', {:controller => 'patient_data', :action => 'checklist', :id => vendor_test_plan.patient_data.id} %>
              <% end %>
            <% end %>
          </td></tr>
          <% if vendor_test_plan.kind.name == "Generate and Format" %><tr>
            <td colspan="6" align="right">
              <div id="execution_div_<%=vendor_test_plan.id%>" style="display:none">
                <% if !vendor_test_plan.clinical_document %>
                  <br/>
                  <% form_for(:clinical_document, 
                              :url => vendor_test_plan_clinical_document_url(vendor_test_plan),
                              :html => {
                                :multipart => true,
                                :onSubmit => %[
                                  if ($("upload_#{vendor_test_plan.id}").value.blank())
                                    { alert("You must specify a file to upload."); return false }
                                  else return true
                                ] }) do |f| -%>
                      <label>Document Type &nbsp;&nbsp;&nbsp;&nbsp;
                        <%= f.select :doc_type, ['C32'] %>
                      </label>
                      <br/>
                      <label>Clinical Document
                        <%= f.file_field  :uploaded_data, :id => "upload_#{vendor_test_plan.id}" %>
                      </label>
                      <br/>
                      <%= submit_tag 'Attach' %>
                  <% end -%>
                <% end %>
              </div>
            </td>
        </tr><% end %> <!-- if generate and format -->
      <% end %> <!-- vendor_test_plan loop -->
      </table> <!-- .dashboard -->
    <% end %> <!-- vendor loop -->
  </div> <!-- .container -->
</div> <!-- .content -->
